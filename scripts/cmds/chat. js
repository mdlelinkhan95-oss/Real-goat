const axios = require("axios");

module.exports = {
  config: {
    name: "chat",
    aliases: ["sim", "robot", "ai", "bot"],
    version: "3.2.0",
    author: "YourFix+SimSimi",
    countDown: 3,
    role: 0,
    shortDescription: "Human-like AI Chatbot",
    longDescription: {
      en: "Chat in Bengali or English. AI replies if you use /chat <message> or mention the bot."
    },
    category: "ai",
    guide: {
      en: "{pn} <your message> | {pn} on/off | Type message with 'bot/ai' to auto-chat."
    },
  },

  langs: {
    en: {
      turnedOn: "âœ… AI Auto Chat enabled!",
      turnedOff: "âŒ AI Auto Chat disabled!",
      error: "Sorry, something went wrong. Please try again! ðŸ˜…",
    },
  },

  onStart: async function ({ args, threadsData, message, event, getLang }) {
    try {
      if (args[0] == "on" || args[0] == "off") {
        await threadsData.set(event.threadID, args[0] == "on", "settings.simsimi");
        return message.reply(args[0] == "on" ? getLang("turnedOn") : getLang("turnedOff"));
      } else if (args.length > 0) {
        const userMessage = args.join(" ");
        const reply = await simsimiReply(userMessage);
        return message.reply(reply);
      }
    } catch (e) {
      console.error("Chat onStart error:", e.message);
      return message.reply(getLang("error"));
    }
  },

  onChat: async function ({ args, message, threadsData, event, isUserCallCommand, getLang }) {
    try {
      if (isUserCallCommand) return;
      const msg = args.join(" ");
      if (!msg || msg.length < 2) return;

      const isAutoModeOn = await threadsData.get(event.threadID, "settings.simsimi");
      const keywords = ["bot", "ai", "robot", "chatbot", "à¦¬à¦Ÿ", "à¦°à§‹à¦¬à¦Ÿ"];
      const mentionsBot = keywords.some((kw) => msg.toLowerCase().includes(kw));
      if (!isAutoModeOn && !mentionsBot) return;

      const reply = await simsimiReply(msg);
      setTimeout(() => message.reply(reply), 900);
    } catch (e) {
      console.error("Chat onChat error:", e.message);
    }
  },
};

// Helper: SimSimi API response (Bengali, fallback to English)
async function simsimiReply(input) {
  input = input.replace(/[\n\r]+/g, " ").trim();
  if (input.length < 1) return "ðŸ˜… Please type something!";
  try {
    // Bengali first, fallback English
    let res = await axios.get("https://api.simsimi.vn/v1/simtalk", {
      params: { text: input, lc: "bn" }, timeout: 5000
    });
    if (res.data && res.data.message) return makeHuman(res.data.message);

    res = await axios.get("https://api.simsimi.vn/v1/simtalk", {
      params: { text: input, lc: "en" }, timeout: 5000
    });
    if (res.data && res.data.message) return makeHuman(res.data.message);

    return getFallback(input);
  } catch (e) {
    return getFallback(input);
  }
}

// Make responses feel more like a real chat
function makeHuman(str) {
  // Add casual!
  let msg = str;
  const emojis = [" ðŸ˜Š", " ðŸ˜Ž", " ðŸ˜„", " ðŸ‘", " ðŸ¤”", "â¤ï¸", "ðŸ”¥"];
  if (Math.random() < 0.22) msg = msg + emojis[Math.floor(Math.random() * emojis.length)];
  const starters = ["Well,", "Hmm,", "So,", "Hey,", "See,", "Actually,"];
  if (Math.random() < 0.15) msg = starters[Math.floor(Math.random() * starters.length)] + " " + msg;
  return msg;
}

// Simple fallback when SimSimi doesn't answer
function getFallback(input) {
  input = input.toLowerCase();
  if (/hello|hi|à¦¹à¦¾à¦‡/.test(input))
    return "à¦¹à§‡à¦²à§‹! ðŸ˜Š à¦•à§‡à¦®à¦¨ à¦†à¦›à§‹?";
  if (/how are you|à¦•à§‡à¦®à¦¨ à¦†à¦›à§‹/.test(input))
    return "à¦­à¦¾à¦²à§‹ à¦†à¦›à¦¿, à¦¤à§à¦®à¦¿ à¦•à§‡à¦®à¦¨?";
  if (/joke|funny|à¦®à¦œà¦¾à¦°|à¦•à§Œà¦¤à§à¦•/.test(input))
    return "à¦à¦•à¦Ÿà¦¾ à¦®à¦œà¦¾à¦° à¦•à¦¥à¦¾ à¦¬à¦²à¦¿? à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¾à¦°à§‡à¦° à¦¸à¦¬ à¦¸à¦®à¦¸à§à¦¯à¦¾ 'à¦‡à¦¤à¦°à¦¨à§‡à¦Ÿ'-à¦à¦°! ðŸ˜‚";
  return "à¦“à¦Ÿà¦¾ à¦¬à§‹à¦§à¦¹à¦¯à¦¼ à¦­à¦¾à¦²à¦­à¦¾à¦¬à§‡ à¦¬à§à¦à¦¤à§‡ à¦ªà¦¾à¦°à¦¿à¦¨à¦¿! ðŸ˜…";
}
